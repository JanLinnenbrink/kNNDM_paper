---
title: "figures_knndmcv"
author: "Jan Linnenbrink"
date: "2023-01-29"
output: html_document
---

# Preparation

```{r calculate difference between CV and true error}
knitr::opts_chunk$set(echo = TRUE)
library("dplyr")
library("tidyr")
library("forcats")

sim_res <- read.csv("results/sim_res.csv")

sim_diff <- data.frame(rmse_rand = sim_res$RMSE_rand - sim_res$RMSE_surf,
                       rmse_spatial = sim_res$RMSE_spatial - sim_res$RMSE_surf,
                       rmse_nndm = sim_res$RMSE_nndm - sim_res$RMSE_surf,
                       rmse_kndm = sim_res$RMSE_kndm - sim_res$RMSE_surf,
                       r2_rand = sim_res$R2_rand - sim_res$R2_surf,
                       r2_spatial= sim_res$R2_spatial - sim_res$R2_surf,
                       r2_nndm = sim_res$R2_nndm - sim_res$R2_surf,
                       r2_kndm = sim_res$R2_kndm - sim_res$R2_surf,
                       mae_rand = sim_res$MAE_rand - sim_res$MAE_surf,
                       mae_spatial = sim_res$MAE_spatial - sim_res$MAE_surf,
                       mae_kndm = sim_res$MAE_kndm - sim_res$MAE_surf,
                       mae_nndm = sim_res$MAE_nndm - sim_res$MAE_surf,
                       dsample = sim_res$dsample) |>
  pivot_longer(!dsample) |>
  mutate(distr = case_when(dsample == "sregular" ~ "Strong\nregular",
                                     dsample == "wregular" ~ "Weak\nregular",
                                     dsample == "random" ~ "Random",
                                     dsample == "wclust" ~ "Weak\nclustered",
                                     dsample == "sclust" ~ "Strong\nclustered"),
         distr = as.factor(distr),
         distr = fct_relevel(distr, c("Strong\nregular", "Weak\nregular", "Random",
                                   "Weak\nclustered", "Strong\nclustered")),
         CV_method = case_when(grepl("rand", name) ~ "random 10-fold",
                               grepl("spatial", name) ~ "spatial 10-fold",
                               grepl("nndm", name) ~ "NNDM LOO",
                               grepl("kndm", name) ~ "kNNDM 10-fold"),
         CV_method = fct_relevel(CV_method, "random 10-fold",  "spatial 10-fold","NNDM LOO","kNNDM 10-fold"),
         group = case_when(startsWith(name, "rmse") ~ "RMSE",
                           startsWith(name, "mae") ~ "MAE",
                           startsWith(name, "r2") ~ "R^2"))

```

# Methods

## example of different sample configurations and the corresponding NND ECDFs

```{r figure 1}
library("ggplot2")
library("sf")
library("CAST")
library("cowplot")
source("code/figures_utils.R")
source("code/simulation/sim_functions.R")

AOI <- st_read(dsn="data/simulation/species_vdata.gpkg", layer="sampling_polygon")
AOI_part <- st_buffer(AOI, -200000)


set.seed(100)
tpoints_rand <- sim2_samples(100, "random", AOI)
tpoints_reg <- sim2_samples(100, "sregular", AOI)
tpoints_cl <-  sim2_samples(100, "sclust", AOI)
tpoints_cl$cl <- "clustered"
tpoints_rand$cl <- "random"
tpoints_reg$cl <- "regular"

tp <- rbind(tpoints_rand, tpoints_cl)

ppoints <- st_sample(AOI, 500, type = "regular") |>
  st_transform(st_crs(tpoints_rand))

set.seed(100)
k_reg <- knndm(tpoints_reg, ppoints=ppoints)
k_rand <- knndm(tpoints_rand, ppoints=ppoints)
k_clust <- knndm(tpoints_cl, k = 2,  ppoints=ppoints, maxp=0.8)

pts.size <- 1
ppts.alpha <- 0.5
base.size <- 12

Ws <- lapply(list(k_reg, k_rand,k_clust), function(x) twosamples::wass_stat(x$Gj, x$Gij))

reg_dist <- plot.knndm.integral(k_reg) +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  geom_text(aes(label=paste("W=", round(Ws[[1]])), x=12^5,y=0.6), size=5, col="orange") +
  xlab("r") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 
 
rand_dist <- plot.knndm.integral(k_rand) + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  geom_text(aes(label=paste("W=", round(Ws[[2]])), x=12^5,y=0.6), size=5, col="orange") +
  xlab("r") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 

clust_dist <- plot.knndm.integral(k_clust) + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  xlab("r") +
  geom_text(aes(label=paste("W=", round(Ws[[3]])), x=12^5,y=0.6), size=5, col="orange") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 
legend_bottom <- get_legend(rand_dist+
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom"))

(pts_cl_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_cl,size=pts.size) +
    scale_color_manual(values = c("blue","orange")) +
    scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl))

pts_reg_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_reg, size=pts.size) +
  scale_color_manual(values= rainbow(10)) +
  scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl)

pts_rand_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_rand, size=pts.size) +
  scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl)

top_row <- plot_grid(pts_reg_pl, pts_rand_pl, pts_cl_pl, nrow=1)
bottom_row <- plot_grid(reg_dist, rand_dist,  clust_dist, nrow=1)
comb_pl <- plot_grid(NULL, top_row, NULL, bottom_row, NULL, legend_bottom, NULL,  
                     nrow=7, rel_heights = c(-0.22,1, -0.42,1,-0.7,1,-0.45))
ggsave("figures/1_example_ecdfs.png", comb_pl, height = 12, width=20, units="cm")
#
```

## kNNDM workflow

```{r figure 2}
library("ggplot2")
library("sf")
library("CAST")
library("cowplot")
source("code/figures_utils.R")

wgrid <- st_read(dsn="data/simulation/species_vdata.gpkg", layer="landscape_grid")
AOI <- st_read(dsn="data/simulation/species_vdata.gpkg", layer="sampling_polygon") |> 
  st_transform(st_crs(wgrid))
set.seed(10)
tpoints <-  sim2_samples(100, "sclust", AOI)
ppoints <- st_sample(AOI, 1000, type = "regular")
tpoints <- st_transform(tpoints, st_crs(ppoints))
AOI <- st_transform(AOI, st_crs(ppoints))


k <- 2
maxp <- 0.8
k_out <- k_plot(k, maxp, tpoints, ppoints)

pts_cl <- st_sf(do.call("cbind.data.frame",k_out[[1]]), geom=st_geometry(tpoints))
W <- k_out[[2]]$W

Gjstar_i <- k_out[[3]]
Gij <- k_out[[4]]
Gj <- k_out[[5]]

df <- lapply(Gjstar_i, function(x) list(x,Gij,Gj))
df <- lapply(df, function(x) {names(x) <- c("Gjstar","Gij","Gj");return(x)})

dist_plts <- mapply(function(x,y){
  plot.knndm(x) +
    ggtitle(paste0("W=", round(y))) +
    scale_x_continuous(limits=c(0,4*10^5), n.breaks = 3) +
    ylab("") +
    theme_bw() +
    theme(aspect.ratio = 1,
          legend.position = NaN,
          title=element_text(size=9))
}, x=df, y=W, SIMPLIFY = FALSE)
dst_pl <- plot_grid(plotlist = dist_plts, nrow = 1)

pts_list <- apply(st_drop_geometry(pts_cl), 2, function(x) x, simplify = FALSE)
pts_list_geo <- lapply(pts_list, function(x) st_sf(x, geom=pts_cl$geom))

pt.size <- 0.8

title_p <- k_out[[6]]

point_pl <- mapply(function(x,y) {
  ggplot() +
    ggtitle(paste0("q=", y)) +
    geom_sf(data=AOI, alpha=0) +
    geom_sf(data=x, aes(col = as.factor(x[[1]])), size=pt.size)+
    scale_color_manual(values=c("blue", "red")) +
    scale_shape_manual(values=rep(16, length(unique(x[[1]])))) +
    scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
    theme_bw()+
    theme(legend.position = NaN,
          title = element_text(size=9))
}, x=pts_list_geo,y=title_p, SIMPLIFY = FALSE)

pts_pl <- plot_grid(plotlist = point_pl, nrow=1)

bottom_row <- plot_grid(dst_pl)
top_row <- plot_grid(pts_pl)
legend_bottom <- get_legend(dist_plts[[1]] +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom"))
c <- plot_grid(NULL,top_row, NULL, bottom_row, NULL, legend_bottom, nrow=6,rel_heights = c(-0.25,1,-0.35,1,-0.2,0.2))
ggsave("figures/2_method_knndm.pdf",c, height=5, width=12)
#
```


# Simulation results

## Results of simulations

```{r figure 3}
library("ggplot2")
library("ggthemes")
library("cowplot")
lw <- 0.6
w <- 0.45
base.size <- 15

diff_rmse <- ggplot(sim_diff[sim_diff$group=="RMSE",],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method") +
    geom_hline(aes(yintercept=0)) +
    xlab("") +
    ylab(expression(CV - true~RMSE)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

diff_R2 <- ggplot(sim_diff[sim_diff$group=="R^2", ],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method",) +
    geom_hline(aes(yintercept=0)) +
    xlab("") +
    ylab(expression(CV - true~R^2)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

diff_MAE <- ggplot(sim_diff[sim_diff$group=="MAE",],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method") +
    geom_hline(aes(yintercept=0)) +
    xlab("Sampling distribution") +
    ylab(expression(CV - true~MAE)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

legend_right <- get_legend(diff_MAE +
                              guides(color = guide_legend(nrow = 4)) +
                              theme(legend.position = "right"))

pgr <- plot_grid(diff_rmse, NULL, NULL, NULL,  
                 diff_R2, legend_right, NULL, NULL,  
                 diff_MAE, NULL,NULL, NULL, 
                 nrow=3, rel_widths = c(1, 0.3, 0.3,-0.3), axis="l", align = "v")
ggsave("figures/3_results_sim.pdf", pgr, height=8, width=8)
#

```


## association between the absolute value difference between the CV and true map accuracy statistics and W statistic

```{r figure 4}
library(ggplot2)
library(cowplot)
cor_res <- read.csv("results/sim_res_W.csv")
cor_diff <- data.frame(rmse_diff = cor_res$RMSE_kndm - cor_res$RMSE_surf,
                       r2_diff = cor_res$R2_kndm - cor_res$R2_surf,
                       mae_diff = cor_res$MAE_kndm - cor_res$MAE_surf,
                       ws = cor_res$WS,
                       dsample = cor_res$dsample)


m <- 0.5
b.size <- 20
lm_rmse <- lm(abs(rmse_diff)~ws, cor_diff)
r2_rmse <- round(summary(lm_rmse)$r.squared,2)
pred_rmse <- predict(lm_rmse, cor_diff)
lm_mae <- lm(abs(mae_diff)~ws, cor_diff)
r2_mae <- round(summary(lm_mae)$r.squared,2)
pred_mae <- predict(lm_mae, cor_diff)
lm_r2 <- lm(abs(r2_diff)~ws, cor_diff)
r2_r2 <- round(summary(lm_r2)$r.squared,2)
pred_r2 <- predict(lm_r2, cor_diff)

print(paste("Rsquared for Rsquared:", r2_r2, ";",
            "Rsquared for MAE:", r2_mae, ";",
            "Rsquared for RMSE:", r2_rmse))

rmse <- ggplot(data=cor_diff, aes(x=ws,y=abs(rmse_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_rmse), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~RMSE))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
          plot.margin = unit(unit(rep(m,4), "cm")))

mae <- ggplot(data=cor_diff, aes(x=ws,y=abs(mae_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_mae), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~MAE))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
          plot.margin = unit(rep(m,4), "cm"))
r2 <- ggplot(data=cor_diff, aes(x=ws,y=abs(r2_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_r2), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~R^2))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
        plot.margin = unit(unit(rep(m,4), "cm")))

legend_bottom <- get_legend(rmse +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom",
                                    legend.key.width  = unit(1.5, "cm"),
                                    legend.key.height  = unit(0.5, "cm"),
                                    plot.margin = unit(c(0, 0, 0, 0), "cm")))
top_row <- plot_grid(rmse, r2, mae, nrow=1, align="hv")
c <- plot_grid(top_row, NULL, legend_bottom, NULL, nrow=4,
               rel_heights = c(1,-0.35,1,-0.4), rel_widths = c(1,1,5,1))

ggsave("figures/4_results_W_err.pdf",c, height=5, width=12)
#
```

# Simulation 2

```{r figure 5}
outfolder <- "C:/0_Msc_Loek/Z_Palma/deBruin_add_nndm/material/"
outtab <- read.csv(file.path(outfolder, "outtab.csv"))
outtab$design <- factor(outtab$design, levels=c("regular", "simpleRandom", "clusterMedium", 
                                                "clusterStrong", "clusterGapped"))
outtab$variate <- as.factor(outtab$variate)

outtab$method <- factor(outtab$method, levels = c("random","spatial","heteroscedastic","intensity",
                                                  "modelbased","knndm_sample", "knndm_sample_4","exhaustive"))

collabs <- c("SRS","reg","clustMed","clustStr","clustGap")

#
library("ggplot2")
library("ggthemes")
library("cowplot")

lw <- 0.6
w <- 0.45
base.size <- 15

(diff_rmse <- ggplot(outtab[outtab$methodID!=0 & outtab$method!="knndm_sample",],
                    aes(x=design, y=rRMSE,colour=method)) +
  geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6), outlier.shape = NA) +
  scale_color_colorblind(name="CV method") +
    scale_x_discrete(labels=collabs) +
    scale_y_continuous(limits=c(-60,60), breaks=seq(-60,60,20)) +
  geom_hline(aes(yintercept=0)) +
  xlab("") +
  ylab(expression(CV - true~RMSE~"[%]")) +
  theme_bw(base_size = base.size) +
  theme(legend.position = "None") +
  facet_wrap(~variate) )

(diff_mec <- ggplot(outtab[outtab$methodID!=0 & outtab$method!="knndm_sample",],
                     aes(x=design, y=rMEC,colour=method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6), outlier.shape = NA) +
    scale_color_colorblind(name="CV method") +
    scale_x_discrete(labels=collabs) +
    scale_y_continuous(limits=c(-40,40), breaks=seq(-40,40,20)) +
    geom_hline(aes(yintercept=0)) +
    xlab("") +
    ylab(expression(CV - true~MEC~"[%]")) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None") +
    facet_wrap(~variate) )

legend_bottom <- get_legend(diff_mec +
                             guides(color = guide_legend(nrow = 2)) +
                             theme(legend.position = "bottom"))

pgr <- plot_grid(diff_rmse, diff_mec, legend_bottom,
                 nrow=3, rel_heights = c(1,1,0.5), axis="l", align = "v")
ggsave("figures/5_results_sim_deBruin.pdf", pgr, height=8, width=10)

```

# Case Study

```{r figure 6}
library("ggplot2")
library("cowplot")
library("rnaturalearth")
library("dplyr")
library("CAST")
source("code/figures_utils.R")

sla_kndm <- readRDS("results/sla_knndm.RDS")
rand_dist <- readRDS("rand_dist.RDS")
err_knndm <- readRDS("results/err_knndm.RDS")
err_rand <- readRDS("results/err_rand.RDS")

lab_knndm <- bquote(
       atop(textstyle(RMSE == .(round(err_knndm[[1]],2))),
                 atop(textstyle(R^2 == .(round(err_knndm[[2]],2))),
                      atop(scriptscriptstyle(""),textstyle(MAE == .(round(err_knndm[[3]],2)))))))

lab_rand <- bquote(
       atop(textstyle(RMSE == .(round(err_rand[[1]],2))),
                 atop(textstyle(R^2 == .(round(err_rand[[2]],2))),
                      atop(scriptscriptstyle(""),textstyle(MAE == .(round(err_rand[[3]],2)))))))


dist_knndm <- plot.knndm(sla_kndm) +  
    annotate(geom="text",x=11.4^6,y=0.4, label=lab_knndm, colour="black",hjust = 0, size=4)+
    theme_bw() +
  theme(legend.position = NaN, aspect.ratio = 1)


dist_rand <- plot.knndm(rand_dist) +  
    annotate(geom="text",x=11.4^6,y=0.4, label=lab_rand, colour="black",hjust = 0, size=4)+
    scale_x_continuous(limits=c(0,max(dist_knndm$data$r))) +
    theme_bw() +
  theme(legend.position = NaN, aspect.ratio = 1)


legend_bottom <- get_legend(dist_rand +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom"))
top_row <- plot_grid(dist_rand,dist_knndm)
sla_dens <- cowplot::plot_grid(top_row, NULL, legend_bottom, NULL, nrow=4, 
                               rel_heights = c(1,-0.2,0.5,-0.1))

ee <- st_crs("+proj=eqearth")
co <- ne_countries(returnclass = "sf")
co.ee <- st_transform(co, ee)

sla_map_rand <- ggplot() +
    geom_sf(data=st_union(co.ee)) +
    geom_sf(data=sla, size=0.2, color=sla_rand) +
    theme_minimal()+
    ggtitle("random 10-fold CV") +
    theme(plot.title = element_text(face="bold", size = 14, hjust = 0.5))

sla_map_knndm <- ggplot() +
    geom_sf(data=st_union(co.ee)) +
    geom_sf(data=sla, size=0.2, color=sla_kndm$clusters) +
    theme_minimal()+
    ggtitle("kNNDM 4-fold CV") +
    theme(plot.title = element_text(face="bold", size = 14, hjust = 0.5))

maps <- plot_grid(sla_map_rand, sla_map_knndm, nrow=1)

bp <- plot_grid(NULL, maps, NULL, sla_dens, NULL, nrow=5,
                rel_heights = c(-0.3,1,-0.3,0.5,0))
ggsave("figures/6_sla_distances.png",bp, height=6, width=10)

print(sla_kndm$W)
print(rand_dist$W)
```




