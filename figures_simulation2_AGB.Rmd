---
title: "Simulation 2: above-ground biomass (AGB)"
author: "Jan Linnenbrink & Carles Milà"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r rmd options, echo=FALSE}
knitr::opts_chunk$set(fig.align = 'center', message = FALSE, echo=FALSE, 
                      warning = FALSE, fig.width = 8, fig.height = 3, dev='pdf')
```

This file contains the code to reproduce the figures of the appendix of the paper "kNNDM: k-fold Nearest Neighbour Distance Matching Cross-Validation for map accuracy assessment" by Jan Linnenbrink, Carles Milà, Marvin Ludwig and Hanna Meyer. The appendix consists of a second simulation, that is based on the above-ground biomass example presented in de Bruin et al. (2022, https://doi.org/10.1016/j.ecoinf.2022.101665).


\newpage
## Data used in simulation 2

This code reproduces Figure S1: Data used in the AGB simulation: A) shows a subset of the 22 predictors, as well as the response raster. The rasters were linearly stretched to [0,1] for visualization purposes. B) shows one iteration of the different sampling designs. Data from \url{https://doi.org/10.5281/zenodo.6513429}.

```{r figS1, fig.height=8, fig.width=10}
library(ggplot2)
library(dplyr)
library(tidyr)
library(sf)
library(terra)
library(tidyterra)
library(cowplot)
library(forcats)
source("simulation1_virtualSpecies/code/figures_utils.R")

infolder  <- "simulation2_AGB/data/"
smpl <- c("regular", "simpleRandom", "clusterMedium", "clusterStrong", "clusterGapped")
title_smpl <- c("regular", "random", "weakly clustered", "medium clustered", "strongly clustered")
loadRData <- function(fileName){
    load(fileName)
    get(ls()[ls() != "fileName"])
}

# load example points
pts_sf <- paste0(infolder, smpl, "/AGBdata001.Rdata") |>
  lapply(function(x) loadRData(x))

pts_sf <- lapply(1:length(pts_sf), function(i) {
  pts_sf[[i]] <- data.frame(x=pts_sf[[i]]$xcoord * 1000, y=pts_sf[[i]]$ycoord * 1000) |> 
    st_as_sf(coords=c("x", "y"), crs="epsg:3035")
  
  pts_sf[[i]]$sampling <- smpl[[i]]
  if(nrow(pts_sf[[i]]) < 5000) {
    pts_sf[[i]][nrow(pts_sf[[i]]):5000, ] <- NA
  }
  pts_sf[[i]] |> 
    select(sampling)
})

pts_sf <- do.call(rbind, pts_sf) |> 
  mutate(sampling = case_when(sampling=="simpleRandom" ~ "random",
                              sampling=="regular" ~ "regular",
                              sampling=="clusterMedium" ~ "weakly clustered",
                              sampling=="clusterStrong" ~ "medium clustered",
                              sampling=="clusterGapped" ~ "strongly clustered"),
         sampling = as.factor(sampling),
         sampling = fct_relevel(sampling, c("regular", "random", "weakly clustered", "medium clustered", "strongly clustered")))


# load AOI
aoi <- quiet(st_read("simulation2_AGB/data/strata.shp")) |> 
  st_union() 
st_crs(aoi) <- st_crs(pts_sf)


# load AGB stack and response surface
# needs to be downloaded from  https://doi.org/10.5281/zenodo.6513429
AGBstack <- rast("~/CrossValidation/data_sim_AGB/AGBstack.tif") # replace by path to downloaded AGB stack
AGB_sample <- AGBstack[[c(3:7,1)]] |> 
  aggregate(10) 
# rescale sample predictors for vizualisation purposes
nx <- minmax(AGB_sample)    
AGB_sample <- (AGB_sample - nx[1,]) / (nx[2,] - nx[1,])
names(AGB_sample) <- c("bio1","bio5", "bio7", "bio12", "bio15", "outcome")


# plot sample points
pts_pl <- ggplot() +
  geom_sf(data=aoi, fill=NaN) +
    geom_sf(data=pts_sf |> drop_na(), size=0.01, stroke=0.01,alpha=1,colour="blue4")+ #size=0.01
    theme_bw()+
    theme(legend.position = NaN,
          title = element_text(size=9)) +
  facet_wrap(~sampling, ncol=2)

# plot sample predictors
pred_map <- ggplot() +
  geom_spatraster(data=AGB_sample) +
  scale_fill_viridis_c("",na.value="transparent") +
  facet_wrap(~lyr, ncol = 2)  +
  theme_bw() +
  theme(legend.position = NaN)

# combine plots of predictors and sample points
legend_pred <- get_legend(pred_map +
                              guides(fill = guide_colorbar(nrow = 1)) +
                              theme(legend.position = "bottom", 
                                    legend.key.width = unit(1, "cm"),
                                    legend.key.height = unit(0.4, "cm")))

legend_pred <- plot_grid(legend_pred, NULL, ncol=2)

pred_pts_mp <- plot_grid(pred_map, pts_pl, ncol=2, align="vh",labels = "AUTO",
                         vjust=3.8)
pred_pts_mp <- plot_grid(pred_pts_mp, NULL, legend_pred, nrow=3, rel_heights = c(1,-0.1,0.2))

ggsave("figures/fig9_AGB_simulation.pdf", pred_pts_mp, width=8, height=6)
pred_pts_mp
```


\newpage
## Comparison of the performance of different CV methods

Differences between Cross-Validated and true RMSE for the first supplementary simulation (Figure S2). kNNDM [tuned] refers to the kNNDM split that yielded the lowest W statistic among different number of folds $k \in [2, 4, 6, ...,  20]$. 

```{r calculate statistics}

infolder  <- "simulation2_AGB/results"
outfolder <- "figures"
mets <- c("exhaustive", "random", "spatial", "knndm", "knndm_tuned")
colnms <- c("method", "variate", "design", "number", "RMSE", "k")
outtab <- data.frame(matrix(NA, 0, 6))
names(outtab) <- colnms

for(m in mets){    

  p <- file.path(infolder, m)
  f_ins <- list.files(p, glob2rx("???_*.Rdata"))
  for(f_in in f_ins){
    lchar <- nchar(f_in)
    variate <- substr(f_in, 1, 3)
    design <- substr(f_in, 5, lchar-9)
    number <- as.numeric(substr(f_in, lchar-8, lchar-6))
    load(file.path(p, f_in))

    if(m == "knndm_tuned") {
      RMSE <- k_err_tuned$RMSE
      k <- k_err_tuned$k
    } else {
      k <- NaN
      RMSE   <- RMSE
    }
    
    newrow <- data.frame(method = m, variate = variate, design = design,
                         number = number, RMSE = RMSE, k=k)
    outtab <- rbind(outtab, newrow)
  }
}

outtab$methodID <- with(outtab, ifelse(method=="exhaustive",0,1))

outtab$rRMSE <- NA

numbers=1:100
for(design in unique(outtab$design)){
    for(number in numbers){
      idx1 <- which(outtab$design == design & outtab$number == number)
      idx2 <- which(outtab$design == design & outtab$methodID == 0 & outtab$number == number)
      
      outtab$rRMSE[idx1] <- outtab$RMSE[idx1] - outtab$RMSE[idx2]
    }
}

write.csv(outtab, file.path(infolder, "outtab100.csv"))
```


```{r figS2}

library(ggplot2)
library(ggthemes)

outtab <- read.csv("simulation2_AGB/results/outtab100.csv")

mets <- c("exhaustive", "random", "spatial", "knndm", "knndm_tuned")
outtab$method <- factor(outtab$method, levels=mets)
outtab$design <- factor(outtab$design, levels=c("regular", "simpleRandom", "clusterMedium", 
                                                "clusterStrong", "clusterGapped"))
outtab$variate <- as.factor(outtab$variate)

CVmethod_labs <- c("random 10-fold", "spatial 10-fold", "kNNDM 10-fold", "kNNDM [tuned]")
xlabs <- c("regular","random","weakly\nclustered","medium\nclustered","strongly\nclustered")

lw <- 0.6
w <- 0.45
diff_RMSE <- ggplot(outtab[outtab$methodID!=0,], aes(x=design, y=rRMSE, colour=method, linetype=method)) +
    geom_boxplot(lwd=lw, width=w,position=position_dodge(0.6)) +
    geom_hline(yintercept = 0, linetype="solid", alpha=0.6) +
    scale_colour_manual(values = c("black", "#E69F00", "#009E73", "#009E73"),name="CV method", labels=CVmethod_labs) +
    scale_linetype_manual(values=c("solid", "solid", "solid", "dashed"),name="CV method", labels=CVmethod_labs) +
    scale_x_discrete(labels=xlabs) +
    ylab("CV - true RMSE") + 
    xlab("") +
    scale_y_continuous(breaks=c(-15,-10,-5,0,5,10)) +
    theme_bw() +
    theme(legend.position = "bottom")

ggsave("figures/fig10_RMSE_diff_AGB.pdf", diff_RMSE, height = unit(4, "cm"), width=unit(6.5, "cm"))
diff_RMSE

```


\newpage
## Association CV - True error and W statistic

The following code reproduces figure S3, which shows the relationship between the absolute value difference between the Cross-Validated and true RMSE with the W statistic in the second simulation. Here, the W statistic explained 28\% of the variation in the absolute value differences.

```{r figS3, fig.height=4,fig.width=20}
library(ggplot2)

infolder  <- "simulation2_AGB/results"
outfolder <- "figures"
mets <- c("exhaustive", "knndm_W") 
colnms <- c("method", "variate", "design", "number", "RMSE", "W")
outtab <- data.frame(matrix(NA, 0, 6))
names(outtab) <- colnms

for(m in mets){
  p <- file.path(infolder, m)
  f_ins <- list.files(p, glob2rx("???_*.Rdata"))
  for(f_in in f_ins){
    lchar <- nchar(f_in)
    variate <- substr(f_in, 1, 3)
    design <- substr(f_in, 5, lchar-9)
    number <- as.numeric(substr(f_in, lchar-8, lchar-6))
    load(file.path(p, f_in))
    if(grepl("knndm_W*", m)) {
      RMSE <- kndm_stats$RMSE_kndm
      W_kndm = kndm_stats$W_kndm
      } else {
      RMSE <- RMSE
      W_kndm = NaN
      }
    
    newrow <- data.frame(method = m, variate = variate, design = design, number = number, 
                         RMSE = RMSE, W = W_kndm)
    outtab <- rbind(outtab, newrow)
  }
}

numbers=1:100
outtab$rRMSE <- NA

outtab$methodID <- with(outtab, ifelse(method=="exhaustive",0,1))

for(design in unique(outtab$design)){
    for(number in numbers){
      idx1 <- which(outtab$design == design & outtab$number == number)
      idx2 <- which(outtab$design == design & outtab$methodID == 0 & outtab$number == number)
      
      outtab$rRMSE[idx1] <- outtab$RMSE[idx1] - outtab$RMSE[idx2]
    }
}


outtab$method <- factor(outtab$method, levels=c("exhaustive", "knndm_W"))

m <- 0.5
b.size <- 20
out_W <- outtab[outtab$methodID!= 0,]
lm_rmse <- lm(abs(rRMSE)~W, out_W)
r2_rmse <- round(summary(lm_rmse)$r.squared,2)
pred_rmse <- predict(lm_rmse, out_W)
print(paste("Rsquared for RMSE:", r2_rmse))

W_RMSE <- ggplot(data=out_W, aes(x=W,y=abs(rRMSE))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_rmse), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") + #trans="log10"
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~RMSE))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = "right",
          plot.margin = unit(unit(rep(m,4), "cm")))


#ggsave("figures/fig11_W_RMSE_AGB.pdf", W_RMSE, height=5, width=12)
W_RMSE
```


\newpage
## Different numbers of k
Following, figure S4 is reproduced, which shows the influence of different numbers of k on the difference between the Cross-Validated and true RMSE (upper row), and on the W stat (lower row). Note that the values of the W statistic were log-scaled.

```{r figS4, fig.height=12, fig.asp=0.8, fig.height=5, fig.width=20}

library(ggplot2)
library(cowplot)
library(dplyr)
library(forcats)
library(tidyr)
library(scales)
library(ggtext)

infolder  <- "simulation2_AGB/results"
outfolder <- "figures"
mets <- c("exhaustive", "knndm_k")
colnms <- c("method", "variate", "design", "number", "RMSE", "W", "k")
outtab <- data.frame(matrix(NA, 0, 7))
names(outtab) <- colnms

for(m in mets){
  p <- file.path(infolder, m)
  f_ins <- list.files(p, glob2rx("???_*.Rdata"))
  for(f_in in f_ins){
    lchar <- nchar(f_in)
    variate <- substr(f_in, 1, 3)
    
    design <- substr(f_in, 5, lchar-9)
    number <- as.numeric(substr(f_in, lchar-8, lchar-6))
    load(file.path(p, f_in))

  if(m=="exhaustive") {
      RMSE <- RMSE
      W = NaN
      k <- NaN
  } else {
      RMSE <- k_err$RMSE
      W <- k_err$W
      k <- k_err$k
  }
    newrow <- data.frame(method = m, variate = variate, design = design, number = number, 
                         RMSE = RMSE, W = W, k=k)
    outtab <- rbind(outtab, newrow)
    } 
    
}

numbers=1:100
outtab$rRMSE <- NA

variate="AGB"
outtab$methodID <- with(outtab, ifelse(method=="exhaustive",0,1))
outtab$method <- with(outtab, ifelse(method!="exhaustive","kNNDM","exhaustive"))

for(design in unique(outtab$design)){
    for(number in numbers){
      idx1 <- which(outtab$design == design & outtab$number == number & outtab$variate == variate)
      idx2 <- which(outtab$design == design & outtab$methodID == 0 & outtab$number == number & 
                      outtab$variate == variate)
      
      outtab$rRMSE[idx1] <- outtab$RMSE[idx1] - outtab$RMSE[idx2]
    }
}

pl_tab <- outtab |> 
  filter(methodID!=0) |> 
  mutate(design = case_when(design=="clusterGapped" ~ "strongly~clustered",
                             design=="clusterStrong" ~ "medium~clustered",
                             design=="clusterMedium" ~ "weakly~clustered",
                             design=="regular" ~ "regular",
                             design=="simpleRandom" ~ "random"),
         design=fct_relevel(design, c("regular", "random", "weakly~clustered",
                                      "medium~clustered", "strongly~clustered")),
         k = as.factor(k)) |>
  rename("CV-true RMSE" = rRMSE, "log10(W)"=W) |> 
  select(-c(variate, methodID, method,RMSE, number)) |> 
  pivot_longer(-c(design, k)) 

pl_tab$name <- as.factor(pl_tab$name)
levels(pl_tab$name) <- c("CV-true~RMSE", expression("log"[10]*"(W)"))

m <- 0.5
b.size <- 20
lw <- 0.6

W_RMSE <- ggplot(pl_tab, aes(x=k, y=ifelse(name == "CV-true~RMSE", value, log10(value)))) +
    geom_boxplot(position=position_dodge(0.6), lwd=lw) +
  geom_hline(yintercept = 0) +
  scale_y_continuous("") +
    xlab("k") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = "None",
          plot.margin = unit(unit(rep(m,4), "cm")),
          axis.text.x = element_markdown(),
          panel.grid.minor   = element_blank()) +
  facet_grid(rows=vars(name), cols=vars(design),
             scales="free_y", labeller=label_parsed)
W_RMSE

#ggsave("figures/fig12_different_k.pdf", W_RMSE, height=8, width=15)

```



