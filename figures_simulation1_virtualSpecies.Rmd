---
title: "Simulation 1: Workflow and results"
author: "Jan Linnenbrink & Carles Milà"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r rmd options, echo=FALSE}
knitr::opts_chunk$set(fig.align = 'center', message = FALSE, echo=FALSE, 
                      warning = FALSE, fig.width = 8, fig.height = 3)
```

This file contains the code to reproduce figures 1, 3, 4, 5, 6 & 7 of the paper "kNNDM: k-fold Nearest Neighbour Distance Matching Cross-Validation for map accuracy estimation" by J Linnenbrink, C Milà, M Ludwig & H Meyer.



## Example: different clustering, NND ECDFs and W statistics

This code reproduces figure 1, where different configurations of training samples and their corresponding nearest neighbour distance (NND) empirical cumulative distribution functions (ECDF) are shown. Also, the Wasserstein statistic is shown in orange.

```{r figure 1, fig.width=10, fig.height=6, message=FALSE}
library("ggplot2")
library("sf")
library("CAST")
library("cowplot")
source("simulation1_virtualSpecies/code/figures_utils.R")
source("simulation1_virtualSpecies/code/sim_functions.R")

distclust_proj <- function(tr_coords, folds){
  alldist <- rep(NA, length(folds))
  for(f in unique(folds)){
    alldist[f == folds] <- c(FNN::knnx.dist(query = tr_coords[f == folds,,drop=FALSE],
                                            data = tr_coords[f != folds,,drop=FALSE], k = 1))
  }
  alldist
}

AOI <- quiet(st_read(dsn="simulation1_virtualSpecies/data/species_vdata.gpkg", layer="sampling_polygon"))[1,]
AOI_part <- st_buffer(AOI, -200000)

set.seed(10)
tpoints_rand <- sim2_samples(100, "random", AOI)
set.seed(10)
tpoints_reg <- sim2_samples(100, "sregular", AOI)
set.seed(10)
tpoints_cl <-  sim2_samples(100, "sclust", AOI)
tpoints_cl$cl <- "clustered"
tpoints_rand$cl <- "random"
tpoints_reg$cl <- "regular"

tcoords_reg <- st_coordinates(tpoints_reg)[,1:2]
tcoords_rand <- st_coordinates(tpoints_rand)[,1:2]
tcoords_clust <- st_coordinates(tpoints_cl)[,1:2]

tp <- rbind(tpoints_rand, tpoints_cl)

set.seed(100)
ppoints <- st_sample(AOI, 500, type = "regular") |>
  st_transform(st_crs(tpoints_rand))

ppoints_coords <- st_coordinates(ppoints)[,1:2]

set.seed(100)
folds_reg <- sample(1:10, nrow(tpoints_reg), replace=TRUE)
set.seed(100)
folds_rand <- sample(1:10, nrow(tpoints_rand), replace=TRUE)
set.seed(100)
folds_cl <- sample(1:10, nrow(tpoints_cl), replace=TRUE)


Gjstar_reg <- distclust_proj(tcoords_reg, folds_reg)
Gjstar_rand <- distclust_proj(tcoords_rand, folds_rand)
Gjstar_cl <- distclust_proj(tcoords_rand, folds_cl)

Gij_reg <- c(FNN::knnx.dist(query = ppoints_coords,
                            data = tcoords_reg, k = 1))
Gij_rand <- c(FNN::knnx.dist(query = ppoints_coords,
                            data = tcoords_rand, k = 1))
Gij_cl <- c(FNN::knnx.dist(query = ppoints_coords,
                            data = tcoords_clust, k = 1))


k_reg <- list("Gij"=Gij_reg, "Gjstar"=Gjstar_reg)
k_rand <- list("Gij"=Gij_rand, "Gjstar"=Gjstar_rand)
k_clust <- list("Gij"=Gij_cl, "Gjstar"=Gjstar_cl)


pts.size <- 1
ppts.alpha <- 0.5
base.size <- 12

Ws <- lapply(list(k_reg, k_rand,k_clust), function(x) twosamples::wass_stat(x$Gj, x$Gij))

reg_dist <- plot.knndm.integral(k_reg) +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  geom_text(aes(label=paste("W=", scales::comma(round(Ws[[1]]))), x=12^5,y=0.6), size=5, col="grey40") +
  xlab("r") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 
 
rand_dist <- plot.knndm.integral(k_rand) + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  geom_text(aes(label=paste("W=", scales::comma(round(Ws[[2]]))), x=12^5,y=0.6), size=5, col="grey40") +
  xlab("r") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 

clust_dist <- plot.knndm.integral(k_clust) + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE),n.breaks = 3, limits=c(0,4*10^5)) +
  xlab("r") +
  geom_text(aes(label=paste("W=", scales::comma(round(Ws[[3]]))), x=12^5,y=0.6), size=5, col="grey40") +
  theme_bw(base_size = base.size) +
  theme(aspect.ratio = 1, legend.position = NaN,plot.margin = unit(rep(0.2,4), "cm")) 

legend_bottom <- get_legend(rand_dist + theme_void() +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom"))

pts_cl_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_cl,size=pts.size) +
    scale_color_manual(values = c("blue","orange")) +
    scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl)

pts_reg_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_reg, size=pts.size) +
  scale_color_manual(values= rainbow(10)) +
  scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl)

pts_rand_pl <- ggplot() +
  geom_sf(data=AOI, alpha=0) +
  geom_sf(data=ppoints, size=0.2, alpha=ppts.alpha) +
  geom_sf(data=tpoints_rand, size=pts.size) +
  scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
  theme_bw(base_size = base.size) +
    theme(legend.position = "None",
          strip.text.x = element_text(size = 12),
          plot.margin = unit(rep(0.2,4), "cm")) +
  facet_wrap(~cl)

top_row <- plot_grid(pts_reg_pl, pts_rand_pl, pts_cl_pl, nrow=1)

bottom_row <- plot_grid(reg_dist  + theme(plot.background = element_rect(fill = NA, colour = NA)), rand_dist + theme(plot.background = element_rect(fill = NA, colour = NA)), clust_dist + theme(plot.background = element_rect(fill = NA, colour = NA)), nrow=1)

theme_bw()$plot.margin

comb_pl <- plot_grid(NULL,
                     top_row + theme(plot.margin = unit(c(5.5,5.5,5.5,5.5), "points")),
                     NULL, 
                     bottom_row + theme(plot.margin = unit(c(5.5,5.5,5.5,5.5), "points")),
                     NULL,
                     legend_bottom,
                     NULL,  
                     nrow=7, 
                     rel_heights = c(-0.22,1, -0.42,1,-0.7,1,-0.45))

#ggsave("figures/fig1_example_ecdfs.png", comb_pl, height = 12, width=20, units="cm")
comb_pl
```

\newpage
## kNNDM algorithm

This code reproduces the kNNDM workflow shown in figure 3. Several numbers of clusters *q* are compared regarding their W statistic (bottom row).

```{r figure 3, fig.width=12,fig.height=6, message=FALSE}
library("ggplot2")
library("sf")
library("CAST")
library("cowplot")
source("simulation1_virtualSpecies/code/figures_utils.R")

wgrid <- quiet(st_read(dsn="simulation1_virtualSpecies/data/species_vdata.gpkg", layer="landscape_grid"))
AOI <- quiet(st_read(dsn="simulation1_virtualSpecies/data/species_vdata.gpkg", layer="sampling_polygon")) |> 
  st_transform(st_crs(wgrid))
set.seed(10)
tpoints <-  sim2_samples(100, "sclust", AOI)
set.seed(10)
ppoints <- st_sample(AOI, 1000, type = "regular")
tpoints <- st_transform(tpoints, st_crs(ppoints))
AOI <- st_transform(AOI, st_crs(ppoints))

k <- 2
maxp <- 0.8
set.seed(10)
k_out <- k_plot(k, maxp, tpoints, ppoints)

pts_cl <- st_sf(do.call("cbind.data.frame",k_out[[1]]), geom=st_geometry(tpoints))
W <- k_out[[2]]$W

Gjstar_i <- k_out[[3]]
Gij <- k_out[[4]]
Gj <- k_out[[5]]

df <- lapply(Gjstar_i, function(x) list(x,Gij,Gj))
df <- lapply(df, function(x) {names(x) <- c("Gjstar","Gij","Gj");return(x)})

dist_plts <- mapply(function(x,y){
  plot.knndm(x) +
    ggtitle(paste0("W=", round(y))) +
    scale_x_continuous(limits=c(0,4*10^5), n.breaks = 3) +
    ylab("") +
    theme_bw() +
    theme(aspect.ratio = 1,
          legend.position = NaN,
          title=element_text(size=9))
}, x=df, y=W, SIMPLIFY = FALSE)
dst_pl <- plot_grid(plotlist = dist_plts, nrow = 1)

pts_list <- apply(st_drop_geometry(pts_cl), 2, function(x) x, simplify = FALSE)
pts_list_geo <- lapply(pts_list, function(x) st_sf(x, geom=pts_cl$geom))

pt.size <- 0.8

title_p <- k_out[[6]]

point_pl <- mapply(function(x,y) {
  ggplot() +
    ggtitle(paste0("q=", y)) +
    geom_sf(data=AOI, alpha=0) +
    geom_sf(data=x, aes(col = as.factor(x[[1]])), size=pt.size)+
    scale_color_manual(values=c("blue", "red")) +
    scale_shape_manual(values=rep(16, length(unique(x[[1]])))) +
    scale_x_continuous(breaks=c(-8,0)) +
    scale_y_continuous(breaks=c(38,42)) +
    theme_bw()+
    theme(legend.position = NaN,
          title = element_text(size=9))
}, x=pts_list_geo,y=title_p, SIMPLIFY = FALSE)

pts_pl <- plot_grid(plotlist = point_pl, nrow=1)

bottom_row <- plot_grid(dst_pl)
top_row <- plot_grid(pts_pl)
legend_bottom <- get_legend(dist_plts[[1]] +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom"))
c <- plot_grid(NULL,top_row, NULL, bottom_row, NULL, legend_bottom, nrow=6,rel_heights = c(-0.25,1,-0.35,1,-0.2,0.2))

#ggsave("figures/fig3_method_knndm.pdf",c, height=5, width=12)
c
```


\newpage
## Simulation data

Figure 4: Data used in the simulation: A) bioclimatic covariates and response (all linearly stretched to [0,1] for visualization purposes); and B) example of one iteration of the sample simulation. Figure reproduced as in Milà et al. (2022).

```{r figure 4 reproduced as in Milà et al. (2022), fig.height=5, fig.width=10}
# Sim2 functions
source("simulation1_virtualSpecies/code/sim_functions.R")

# Read data
spoly <- quiet(st_read(dsn="simulation1_virtualSpecies/data/species_vdata.gpkg", layer="sampling_polygon"))
wclim <- stack("simulation1_virtualSpecies/data/species_stack.grd")

# Simulate points
set.seed(1234)
psamples1 <- mutate(sim2_samples(100, "sregular", spoly), distr="Strongly regular")
psamples2 <- mutate(sim2_samples(100, "wregular", spoly), distr="Weakly regular")
psamples3 <- mutate(sim2_samples(100, "random", spoly), distr="Random")
psamples4 <- mutate(sim2_samples(100, "wclust", spoly), distr="Weakly clustered")
psamples5 <- mutate(sim2_samples(100, "sclust", spoly), distr="Strongly clustered")
psamples <- bind_rows(psamples1, psamples2, psamples3, psamples4, psamples5)
psamples$distr <- fct_inorder(psamples$distr)

# Plot landscape
p1 <- rasterVis::levelplot(stretch(wclim, minv=0, maxv=1), 
                           layout=c(4, 5), margin=F, scales=list(draw=FALSE))

# Plot samples
p2 <- ggplot() +
  geom_sf(data=spoly, alpha=0.2, colour="grey50") +
  geom_sf(data=psamples, size=0.2) +
  facet_wrap(~distr, ncol=2) + 
  theme_bw()

p12 <- plot_grid(p1, p2, nrow=1, labels=c("A", "B"), rel_widths = c(1.2, 1))
p12
#save_plot("figures/fig4_sim_workflow.pdf", p12, base_height=5, base_asp=1.7)
```



\newpage
## Simulation results

The following code reproduces figure 5, and shows the differences between cross-validated and true RMSE, R^2 and MAE for different sampling distributions.

```{r figure 5, fig.width=8, fig.height=8, message=FALSE}
library("ggplot2")
library("ggthemes")
library("cowplot")
library("dplyr")
library("tidyr")
library("forcats")

# read and process the simulation results
sim_res <- read.csv("simulation1_virtualSpecies/results/sim_res.csv") |> 
  rename("RMSE_knndm" = RMSE_kndm,
         "MAE_knndm" = MAE_kndm,
         "R2_knndm" = R2_kndm)

sim_diff <- data.frame(rmse_rand = sim_res$RMSE_rand - sim_res$RMSE_surf,
                       rmse_spatial = sim_res$RMSE_spatial - sim_res$RMSE_surf,
                       rmse_nndm = sim_res$RMSE_nndm - sim_res$RMSE_surf,
                       rmse_knndm = sim_res$RMSE_knndm - sim_res$RMSE_surf,
                       r2_rand =  sim_res$R2_rand - sim_res$R2_surf,
                       r2_spatial= sim_res$R2_spatial - sim_res$R2_surf,
                       r2_nndm = sim_res$R2_nndm - sim_res$R2_surf,
                       r2_knndm = sim_res$R2_knndm - sim_res$R2_surf,
                       mae_rand = sim_res$MAE_rand - sim_res$MAE_surf,
                       mae_spatial = sim_res$MAE_spatial - sim_res$MAE_surf,
                       mae_knndm = sim_res$MAE_knndm - sim_res$MAE_surf,
                       mae_nndm = sim_res$MAE_nndm - sim_res$MAE_surf,
                       dsample = sim_res$dsample) |>
  pivot_longer(!dsample) |>
  mutate(distr = case_when(dsample == "sregular" ~ "Strongly\nregular",
                                     dsample == "wregular" ~ "Weakly\nregular",
                                     dsample == "random" ~ "Random",
                                     dsample == "wclust" ~ "Weakly\nclustered",
                                     dsample == "sclust" ~ "Strongly\nclustered"),
         distr = as.factor(distr),
         distr = fct_relevel(distr, c("Strongly\nregular", "Weakly\nregular", "Random",
                                   "Weakly\nclustered", "Strongly\nclustered")),
         CV_method = case_when(grepl("rand", name) ~ "random 10-fold",
                               grepl("spatial", name) ~ "spatial 10-fold",
                               grepl("_nndm", name) ~ "NNDM LOO",
                               grepl("knndm", name) ~ "kNNDM 10-fold"),
         CV_method = fct_relevel(CV_method, "random 10-fold",  "spatial 10-fold","NNDM LOO","kNNDM 10-fold"),
         group = case_when(startsWith(name, "rmse") ~ "RMSE",
                           startsWith(name, "mae") ~ "MAE",
                           startsWith(name, "r2") ~ "R^2"))

lw <- 0.6
w <- 0.45
base.size <- 15

diff_rmse <- ggplot(sim_diff[sim_diff$group=="RMSE",],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method") +
    geom_hline(aes(yintercept=0)) +
    xlab("") +
    ylab(expression(CV - true~RMSE)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

diff_R2 <- ggplot(sim_diff[sim_diff$group=="R^2", ],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method",) +
    geom_hline(aes(yintercept=0)) +
    xlab("") +
    ylab(expression(CV - true~R^2)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

diff_MAE <- ggplot(sim_diff[sim_diff$group=="MAE",],
                          aes(x=distr, y=value,colour=CV_method)) +
    geom_boxplot(fill=NA, lwd=lw, width=w,position=position_dodge(0.6)) +
    scale_color_colorblind(name="CV method") +
    geom_hline(aes(yintercept=0)) +
    xlab("Sampling distribution") +
    ylab(expression(CV - true~MAE)) +
    theme_bw(base_size = base.size) +
    theme(legend.position = "None")

legend_right <- get_legend(diff_MAE +
                              guides(color = guide_legend(nrow = 4)) +
                              theme(legend.position = "right"))

pgr <- plot_grid(diff_rmse, NULL, NULL, NULL,  
                 diff_R2, legend_right, NULL, NULL,  
                 diff_MAE, NULL,NULL, NULL, 
                 nrow=3, rel_widths = c(1, 0.3, 0.3,-0.3), axis="l", align = "v")

#ggsave("figures/fig5_results_sim.pdf", pgr, height=8, width=8)
pgr

# get mean and sd
sim_diff |> 
  filter(name %in% c("rmse_knndm", "rmse_nndm", "mae_knndm", "mae_nndm") & dsample == "sclust") |> 
  group_by(name, dsample) |> 
  summarise(mean = mean(value), 
            sd = sd(value)) 
```


\newpage
## Association CV - True error and W statistic

The following code reproduces figure 6, which shows the association between the absolute value difference between the CV and true map accuracy statistics and W statistic.

```{r figure 6, fig.width=10,fig.height=5, message=FALSE}
library("ggplot2")
library("cowplot")
library("dplyr")
cor_res <- read.csv("simulation1_virtualSpecies/results/sim_res_W.csv") |> 
  rename("RMSE_knndm" = RMSE_kndm,
         "R2_knndm" = R2_kndm,
         "MAE_knndm" = MAE_kndm)

cor_diff <- data.frame(rmse_diff = cor_res$RMSE_knndm - cor_res$RMSE_surf,
                       r2_diff = cor_res$R2_knndm - cor_res$R2_surf,
                       mae_diff = cor_res$MAE_knndm - cor_res$MAE_surf,
                       ws = cor_res$WS,
                       dsample = cor_res$dsample)


m <- 0.5
b.size <- 20
lm_rmse <- lm(abs(rmse_diff)~ws, cor_diff)
r2_rmse <- round(summary(lm_rmse)$r.squared,2)
pred_rmse <- predict(lm_rmse, cor_diff)
lm_mae <- lm(abs(mae_diff)~ws, cor_diff)
r2_mae <- round(summary(lm_mae)$r.squared,2)
pred_mae <- predict(lm_mae, cor_diff)
lm_r2 <- lm(abs(r2_diff)~ws, cor_diff)
r2_r2 <- round(summary(lm_r2)$r.squared,2)
pred_r2 <- predict(lm_r2, cor_diff)

print(paste("Rsquared for Rsquared:", r2_r2, ";",
            "Rsquared for MAE:", r2_mae, ";",
            "Rsquared for RMSE:", r2_rmse))

rmse <- ggplot(data=cor_diff, aes(x=ws,y=abs(rmse_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_rmse), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~RMSE))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
          plot.margin = unit(unit(rep(m,4), "cm")))

mae <- ggplot(data=cor_diff, aes(x=ws,y=abs(mae_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_mae), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~MAE))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
          plot.margin = unit(rep(m,4), "cm"))
r2 <- ggplot(data=cor_diff, aes(x=ws,y=abs(r2_diff))) +
    geom_bin_2d(bins=30) +
    geom_line(aes(y=pred_r2), col="black", linewidth=1.2) +
    scale_fill_viridis_b(trans="log10") +
    scale_x_continuous(n.breaks = 3,labels = function(x) format(x, scientific = FALSE)) +
    ylab(expression(abs(CV - true~R^2))) +
    xlab("W") +
    theme_bw(base_size=b.size) +
    theme(aspect.ratio=1, legend.position = NaN,
        plot.margin = unit(unit(rep(m,4), "cm")))

legend_bottom <- get_legend(rmse +
                              guides(color = guide_legend(nrow = 1)) +
                              theme(legend.position = "bottom",
                                    legend.key.width  = unit(1.5, "cm"),
                                    legend.key.height  = unit(0.5, "cm"),
                                    plot.margin = unit(c(0, 0, 0, 0), "cm")))
top_row <- plot_grid(rmse, r2, mae, nrow=1, align="hv")
comb <- plot_grid(top_row, NULL, legend_bottom, NULL, nrow=4,
               rel_heights = c(1,-0.35,1,-0.4), rel_widths = c(1,1,5,1))

#ggsave("figures/fig6_results_W_err.pdf",comb, height=5, width=12)
comb
```


\newpage
## Different numbers of k

Figure 7: CV error estimates for kNNDM CV with different numbers of $k$ (first three rows). The respective W stat is shown in the fourth row.

```{r figure 7, fig.width=8, fig.height=8, message=FALSE}
library("ggplot2")
library("ggthemes")
library("cowplot")
library("dplyr")
library("tidyr")
library("forcats")

# read and process the simulation results
sim_res <- read.csv("simulation1_virtualSpecies/results/sim_res_k1.csv")

sim_diff <- data.frame(rmse_knndm = sim_res$RMSE_knndm - sim_res$RMSE_surf,
                       r2_knndm = sim_res$R2_knndm - sim_res$R2_surf,
                       mae_knndm = sim_res$MAE_knndm - sim_res$MAE_surf,
                       W_knndm = sim_res$W_knndmCV,
                       dsample = sim_res$dsample, k=sim_res$k) |>
  pivot_longer(!c(dsample,k)) |>
  mutate(distr = case_when(dsample == "sregular" ~ "Strongly~regular",
                                     dsample == "wregular" ~ "Weakly~regular",
                                     dsample == "random" ~ "Random",
                                     dsample == "wclust" ~ "Weakly~clustered",
                                     dsample == "sclust" ~ "Strongly~clustered"),
         distr = as.factor(distr),
         distr = fct_relevel(distr, c("Strongly~regular", "Weakly~regular", "Random",
                                   "Weakly~clustered", "Strongly~clustered")),
         CV_method = "kNNDM 10-fold",
         group = case_when(startsWith(name, "rmse") ~ "CV-true~RMSE",
                           startsWith(name, "mae") ~ "CV-true~MAE",
                           startsWith(name, "r2") ~ "CV-true~R^2",
                           startsWith(name, "W_") ~ "W"),
         group=fct_relevel(group, "CV-true~RMSE", "CV-true~R^2", "CV-true~MAE", "W")) |> 
  group_by(distr, k, group) |> 
  summarise_at(vars(value),
               list(Q1=~quantile(., probs = 0.25),
                    median=median, Q3=~quantile(., probs = 0.75)))

  
lw <- 0.4
w <- 0.45
base.size <- 12

k_pl <- ggplot(sim_diff, aes(x=k, group=k)) +
  geom_line(aes(y=median, group=distr), colour="navy") +
  geom_point(aes(y=median), shape=21, size=0.8, colour="navy") +
  geom_errorbar(aes(ymin=Q1, ymax=Q3), 
                  width=0.4, linewidth=0.2, colour="navy") +
  geom_hline(yintercept = 0) +
  scale_y_continuous("") +
  scale_x_continuous(breaks=seq(2,20,6)) +
    xlab("k") +
    theme_bw(base_size = base.size) +
    theme(aspect.ratio = 1, legend.position = "None",
          #axis.text.x = element_markdown(),
          panel.grid.minor = element_blank()) +
  facet_grid(rows=vars(group), cols=vars(distr),
             scales="free_y", labeller=label_parsed)

#ggsave("figures/fig7_diff_k.pdf", k_pl, height=6, width=8)
k_pl
```


\newpage
## Computational time

The following code reproduces figure 8, which compares NNDM LOOCV and kNNDM CV regarding their computational time requirements.

```{r figure 8, fig.width=8.5,fig.height=6, message=FALSE}

library("ggplot2")
library("dplyr")
library("forcats")
library("tidyr")

time_res <- bind_rows(read.csv("simulation1_virtualSpecies/results/time_res_sclust.csv"),
                      read.csv("simulation1_virtualSpecies/results/time_res_rand.csv")) |> 
  mutate(distr = case_when(dsample == "random" ~ "Random", dsample == "sclust" ~ "Strongly\nclustered"),
         distr = as.factor(distr),
         distr = fct_relevel(distr, c("Random", "Strongly\nclustered")))
  

names(time_res) <- c("dsample", "knndm_time_model", "nndm_time_model", "knndm_time_algorithm", "nndm_time_algorithm", "n_tpoints", "distr")


tm <- time_res |> 
  dplyr::select(-dsample) |> 
  mutate(knndm_total = knndm_time_algorithm + knndm_time_model,
         nndm_total = nndm_time_algorithm + nndm_time_model) |> 
  group_by(n_tpoints, distr) |> 
  pivot_longer(!c(n_tpoints, distr)) |> 
  ungroup()

tm$what <- sub(pattern = ".*_", "", x = tm$name)
tm$type <- sub(pattern = "\\_.*", "", x = tm$name)


tp_ext <- ggplot(tm, aes(x=n_tpoints, y=value/3600, colour=type, group=what)) +
  geom_point() +
  facet_grid(distr~what) +
  scale_colour_discrete(name="", labels=c("kNNDM 10-fold CV", "NNDM LOO CV")) +
  scale_x_continuous(limits=c(0,4000), breaks=c(0,2000,4000)) +
  scale_y_log10(labels = function(x) format(x, scientific = FALSE)) +
  xlab("n training points") +
  ylab("time [h]") +
  theme_bw(base_size=15) +
  theme(legend.position = "bottom")


tp_ext

#ggsave("figures/fig8_time_analysis.pdf", tp_ext, height=6, width=8.5)

tm |> 
  dplyr::filter(what=="total") |> 
  dplyr::select(-c("type", "what")) |> 
  pivot_wider(names_from=name, values_from=value) |> 
  mutate(
    "knndm_total" = knndm_total/(60^2),
    "nndm_total" =  nndm_total/(60^2),
    "time_diff" = (nndm_total-knndm_total)) |> 
  filter(n_tpoints==4000)

(tm_summary <- tm |> 
  dplyr::filter(what=="total") |> 
  dplyr::select(-c("type", "what")) |> 
  pivot_wider(names_from=name, values_from=value) |> 
  summarise(reduction_mean = mean(nndm_total/knndm_total),
            reduction_sd = sd(nndm_total/knndm_total),
            reduction_max = max(nndm_total/knndm_total),
            reduction_min = min(nndm_total/knndm_total)))

print(paste0("mean reduction = ", tm_summary$reduction_mean |> round(0), 
             "; sd of the reduction = ", tm_summary$reduction_sd |> round(0)))
```


